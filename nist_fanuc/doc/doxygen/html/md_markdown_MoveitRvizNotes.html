<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>CRCL FANUC: Moveit</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CRCL FANUC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Moveit </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Last updated: 3/23/2016 12:17:37 PM</p>
<h2>Moveit failed to plan also </h2>
<pre class="fragment">[ INFO] [1456439525.551846365]: Planning request received for MoveGroup action. Forwarding to planning pipeline.
[ WARN] [1456439525.554072295]: Orientation constraint for link 'tool0' is probably incorrect: 0.000000, 0.000000, 0.000000, 0.000000. Assuming identity instead.
[ WARN] [1456439525.554147337]: Orientation constraint for link 'tool0' is probably incorrect: 0.000000, 0.000000, 0.000000, 0.000000. Assuming identity instead.
[ INFO] [1456439525.554827784]: LBKPIECE1: Starting planning with 1 states already in datastructure
[ INFO] [1456439526.966671637]: Found a contact between 'link_4' (type 'Robot link') and 'base_link' (type 'Robot link'), which constitutes a collision. Contact information is not stored.
[ INFO] [1456439526.966721656]: Collision checking is considered complete (collision was found and 0 contacts are stored)
[ INFO] [1456439526.967459590]: Found a contact between 'link_6' (type 'Robot link') and 'base_link' (type 'Robot link'), which constitutes a collision. Contact information is not stored.
[ INFO] [1456439526.967502013]: Collision checking is considered complete (collision was found and 0 contacts are stored)
[ INFO] [1456439526.968228658]: Found a contact between 'link_4' (type 'Robot link') and 'base_link' (type 'Robot link'), which constitutes a collision. Contact information is not stored.
[ INFO] [1456439526.968269033]: Collision checking is considered complete (collision was found and 0 contacts are stored)
[ INFO] [1456439526.969014693]: Found a contact between 'link_6' (type 'Robot link') and 'base_link' (type 'Robot link'), which constitutes a collision. Contact information is not stored.
[ INFO] [1456439526.969054959]: Collision checking is considered complete (collision was found and 0 contacts are stored)
[ERROR] [1456439528.325962429]: LBKPIECE1: Unable to sample any valid states for goal tree
[ INFO] [1456439528.325996844]: LBKPIECE1: Created 1 (1 start + 0 goal) states in 1 cells (1 start (1 on boundary) + 0 goal (0 on boundary))
[ INFO] [1456439528.326030131]: No solution found after 2.771767 seconds
[ INFO] [1456439528.326055767]: Unable to solve the planning problem
</pre><h2>Moveit planner hangs </h2>
<pre class="fragment">    if (!group-&gt;plan(my_plan))
        return false;
</pre><p>You must have multithreaded enabled before any moveit planning. </p>
<pre class="fragment">        // Required for multithreaded communication with moveit components
        ros::AsyncSpinner spinner(1);
        spinner.start();
</pre><h2>moveit planning with joints </h2>
<pre class="fragment">    joints.position = moveit.SetRandomJoints();
    std::cout &lt;&lt; "Random assigned joints=" &lt;&lt; VectorDump&lt;double&gt; (joints.position).c_str();
    moveit.Plan(joints);
    sleep(15.0);
    js = moveit.GetJointValues();
    std::cout &lt;&lt; "Current joints=" &lt;&lt; VectorDump&lt;double&gt; (js);
</pre><p>You must wait for rviz to move. You get all kinds of plans.</p>
<h2>rviz not moving </h2>
<pre class="fragment">pub &lt;topic-name&gt; &lt;topic-type&gt; [data...]

rostopic pub -1 /joint_states sensor_msgs/JointState '{header: auto, name: ['joint_1', 'joint_2', 'joint_3', 'joint_4', 'joint_5', 'joint_6'], position: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ], velocity: [], effort: []}'

rostopic pub -1 /joint_states sensor_msgs/JointState '{header: auto, name: ['joint_1', 'joint_2', 'joint_3', 'joint_4', 'joint_5', 'joint_6'], position: [0.097, 0.007, -0.590, -0.172, 0.604, -0.142 ], velocity: [], effort: []}'

rostopic pub /joint_states sensor_msgs/JointState '{header: auto, name: ['joint_1', 'joint_2', 'joint_3', 'joint_4', 'joint_5', 'joint_6'], position: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ], velocity: [], effort: []}'
</pre><h2>Writing joint values to rviz and then moving robot and "waiting" until rviz reaches goal </h2>
<p>Fixed ToVector by making template parameter mandatory.</p>
<p>Then added wait until "AtGoal" motion control. Rviz need processing and that only comes when waiting.</p>
<p>Again, make sure ros::AsyncSpinner is running! </p>
<pre class="fragment">        joint.position=ToVector&lt;double&gt;(6, 0.097, 0.007, -0.590, -0.172, 0.604, -0.142 );
        jointWriter-&gt;JointTrajectoryPositionWrite(joint);
        while( !MotionControl::AtGoal(joint, curjoints) &amp;&amp; n++ &lt; 100) {
            curjoints = jointReader-&gt;GetCurrentReadings();
            std::cout &lt;&lt; "Goal joints=" &lt;&lt; VectorDump&lt;double&gt; (joint.position).c_str();
            std::cout &lt;&lt; "Cur  joints=" &lt;&lt; VectorDump&lt;double&gt; (curjoints.position).c_str();
            Globals.Sleep(100); // 100 milliseconds
        }

template&lt;typename T&gt;
static bool epsiloncompare (T &amp;i, T&amp; j) {
  return (fabs(i-j) &lt; MotionControl::epsilon);
}
template&lt;typename T&gt;
static bool VectorCompare(std::vector&lt;T&gt; vec1,std::vector&lt;T&gt; vec2 )
{
   return std::equal (vec1.begin(), vec1.end(),  vec2.begin() , epsiloncompare) ;
}
bool MotionControl::AtGoal(JointState goal, JointState current,  double epsilon)
{
    MoveitTrajectory::epsilon=epsilon;
    return VectorCompare&lt;double&gt;(goal.position, current.position);
}
</pre><h2>Turn off Planned Path visualization in Rviz - confusing </h2>
<p>In Rviz GUI, navigate to Planned Path, and uncheck "Show Robot Visual"</p>
<p>Not sure how this parameter is set in /move_group/display_planned_path</p>
<h2>Using waypoints in moveit </h2>
<p>Calculated a waypoint every 1mm </p>
<pre class="fragment">std::vector&lt;JointState&gt; MoveitTrajectory::Plan(std::vector&lt;urdf::Pose&gt;&amp; pwaypoints) {
    std::vector&lt;geometry_msgs::Pose&gt; waypoints;
    for(size_t i=0; i&lt; pwaypoints.size(); i++)
    {    
        waypoints.push_back(PoseMsg2UrdfPose(pwaypoints[i]));
    }

    moveit_msgs::RobotTrajectory trajectory;
    double fraction = group-&gt;computeCartesianPath(waypoints,
            0.001, // cartesian path to be interpolated at a resolution of 1 mm 
            0.0, // NO jump_threshold
            trajectory);  // trajectory.joint_trajectory.points  (position)
    std::vector&lt;JointState&gt; points;
    for(size_t j=0; j&lt; trajectory.joint_trajectory.points.size(); j++)
    {
        JointState traj;
        traj.position = trajectory.joint_trajectory.points[j].positions;
        points.push_back(traj);
    }
    return points;
}
</pre><p>Test code: </p>
<pre class="fragment">       MoveitTrajectory moveit(nh);
        MotionControl motioncontrol;
        urdf::Pose goalpose;
        goalpose.position =urdf::Vector3(.28,-0.7,1.0);
        goalpose.rotation.setFromRPY(0.,0.,0.);

        int nIncr=motioncontrol.computeIncrements (RCS::Controller.status.currentpose, goalpose);
        std::vector&lt;urdf::Pose&gt; poses = motioncontrol.computeWaypoints(RCS::Controller.status.currentpose, goalpose, nIncr, true );
        std::vector&lt;JointState&gt; points = moveit.Plan(poses);
        for(size_t k=0; k&lt; points.size(); k++)
        {
            std::cout &lt;&lt;  VectorDump&lt;double&gt; (points[k].position);
            jointWriter-&gt;JointTrajectoryPositionWrite(points[k]);
        }
</pre><p>Fanuc 200id kinematics plugin</p>
<p>/home/michalos/catkin_ws/src/fanuc_experimental/fanuc_lrmate200id_moveit_config/config/kinematics.yaml </p>
<pre class="fragment">manipulator:
  kinematics_solver: fanuc_lrmate200id_manipulator_kinematics/IKFastKinematicsPlugin
  kinematics_solver_attempts: 3
  kinematics_solver_search_resolution: 0.005
  kinematics_solver_timeout: 0.005
</pre><p>Maybe: </p>
<h1>kinematics_solver: kdl_kinematics_plugin/KDLKinematicsPlugin</h1>
<p>Worked! </p>
<pre class="fragment">void visualize(ros::NodeHandle nh, moveit_msgs::MotionPlanResponse response) {
    ROS_INFO("Visualizing the trajectory");
    ros::Publisher display_publisher = nh.advertise&lt;moveit_msgs::DisplayTrajectory&gt;("/move_group/display_planned_path", 1, true);
    moveit_msgs::DisplayTrajectory display_trajectory;

    display_trajectory.trajectory_start = response.trajectory_start;
    display_trajectory.trajectory.push_back(response.trajectory);
    display_publisher.publish(display_trajectory);
}
</pre><p>Ros Cartesian Planning with assigned plugin </p>
<pre class="fragment">int main(int argc, char **argv) {
    ros::init (argc, argv, "planning_pipeline");
    ros::AsyncSpinner spinner(1);
    spinner.start();
    ros::NodeHandle node_handle("~");

    //map&lt;int, Controller*&gt; controllersOrder;
    //vector&lt;Controller&gt;  controllers ;//= initControllers(node_handle);


    robot_model_loader::RobotModelLoader robot_model_loader("robot_description");
    robot_model::RobotModelPtr robot_model = robot_model_loader.getModel();

    planning_scene::PlanningScenePtr planning_scene(new planning_scene::PlanningScene(robot_model));
    planning_pipeline::PlanningPipelinePtr planning_pipeline(new planning_pipeline::PlanningPipeline(robot_model, node_handle, "planning_plugin", "request_adapters"));

    //Sleep a little to allow time to startup rviz, etc.
    ros::WallDuration sleep_time(5.0);
    sleep_time.sleep();

    // A tolerance of 0.01 m is specified in position
    // and 0.01 radians in orientation
    vector&lt;double&gt; tolerance_pose(3, 0.01);
    vector&lt;double&gt; tolerance_angle(3, 0.01);

    // Pose Goal
    // ^^^^^^^^^
    // We will now create a motion plan request for the right arm of the PR2
    // specifying the desired pose of the end-effector as input.
    planning_interface::MotionPlanRequest req;
    planning_interface::MotionPlanResponse res;
    geometry_msgs::PoseStamped pose;
    pose.header.frame_id = "torso";
    pose.pose.position.x = -0.000006;
    pose.pose.position.y = 0.05;
    pose.pose.position.z = -0.24;

    req.group_name = "leg_left";
    req.planner_id = "RRTkConfigDefault";
    req.allowed_planning_time=5;
    req.num_planning_attempts = 5;

    moveit_msgs::Constraints pose_goal = kinematic_constraints::constructGoalConstraints("l_sole", pose, tolerance_pose, tolerance_angle);
    req.goal_constraints.push_back(pose_goal);

    planning_pipeline-&gt;generatePlan(planning_scene, req, res);
    if(res.error_code_.val != res.error_code_.SUCCESS) {
        ROS_ERROR("Could not compute plan successfully");
        return 0;
    }

    moveit_msgs::MotionPlanResponse response;
    res.getMessage(response);

    // Visualize the result
        ROS_INFO("Visualizing the trajectory");
    ros::Publisher display_publisher = node_handle.advertise&lt;moveit_msgs::DisplayTrajectory&gt;("/move_group/display_planned_path", 1, true);
    moveit_msgs::DisplayTrajectory display_trajectory;

    display_trajectory.trajectory_start = response.trajectory_start;
    display_trajectory.trajectory.push_back(response.trajectory);
    display_publisher.publish(display_trajectory);


    //visualize(node_handle, response);

    ros::waitForShutdown();

    return 0;</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 15 2016 14:48:00 for CRCL FANUC by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
